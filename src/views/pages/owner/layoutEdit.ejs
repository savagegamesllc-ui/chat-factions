<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title><%= title %></title>
    <link rel="stylesheet" href="/public/css/app.css" />
  </head>
  <body>
    <div class="container">

      <div class="header">
        <div class="brand">
          <div class="brand-dot"></div>
          <div>
            <h1>Owner â€” Layouts</h1>
            <div class="sub">
              <%= mode === 'create' ? 'Create a new overlay layout' : 'Edit overlay layout settings' %>
            </div>
          </div>
        </div>

        <div class="nav">
          <a href="/owner">Owner Home</a>
          <a class="active" href="/owner/layouts">Layouts</a>
          <a href="/owner/streamers">Streamers</a>
          <a href="/admin">Streamer Dashboard</a>
        </div>
      </div>

      <div id="status" class="notice" style="display:none;"></div>

      <div class="card">
        <div class="card-title">
          <h2><%= mode === 'create' ? 'Create Layout' : 'Edit Layout' %></h2>
          <div class="hint">Owner-only</div>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:flex-start;">
          <a class="btn" href="/owner/layouts">Back to Layouts</a>

          <% if (mode === 'edit' && layout && layout.id) { %>
            <span class="badge">
              ID: <span class="mono"><%= layout.id %></span>
            </span>
          <% } %>
        </div>

        <div class="hr"></div>

        <form method="post" action="<%= mode === 'create' ? '/owner/layouts/new' : ('/owner/layouts/' + layout.id) %>">
          <div style="margin-bottom: 12px;">
            <div class="small muted" style="margin-bottom: 6px;">Name</div>
            <input class="input" name="name" type="text" value="<%= layout.name %>" />
          </div>

          <div style="margin-bottom: 12px;">
            <div class="small muted" style="margin-bottom: 6px;">
              styleKey <span class="muted">(maps to <span class="mono">/public/overlays/styles/&lt;styleKey&gt;.js</span>)</span>
            </div>
            <input class="input" name="styleKey" type="text" value="<%= layout.styleKey %>" />
          </div>

          <div style="margin-bottom: 12px;">
            <div class="small muted" style="margin-bottom: 6px;">Tier</div>
            <select name="tier">
              <option value="FREE" <%= layout.tier === 'FREE' ? 'selected' : '' %>>FREE</option>
              <option value="PRO" <%= layout.tier === 'PRO' ? 'selected' : '' %>>PRO</option>
            </select>
          </div>

          <div style="margin-bottom: 12px;">
            <label class="muted" style="display:flex; align-items:center; gap:10px;">
              <input name="isActive" type="checkbox" <%= layout.isActive ? 'checked' : '' %> />
              Active
            </label>
          </div>

          <div class="hr"></div>

          <div style="margin-bottom: 12px;">
            <div class="small muted" style="margin-bottom: 6px;">defaultConfig (JSON)</div>
            <textarea name="defaultConfig" rows="10"><%= layout.defaultConfig %></textarea>
            <div class="small muted" style="margin-top: 6px;">
              Used as the base config when a streamer selects this layout.
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <div class="small muted" style="margin-bottom: 6px;">metadata (JSON)</div>
            <textarea name="metadata" rows="8"><%= layout.metadata %></textarea>
            <div class="small muted" style="margin-top: 6px;">
              Optional: tags, description, preview hints, etc.
            </div>
          </div>

          <div class="row" style="justify-content:flex-start;">
            <button class="btn primary" type="submit">
              <%= mode === 'create' ? 'Create' : 'Save' %>
            </button>

            <% if (mode === 'edit' && layout && layout.id) { %>
              <a class="btn" href="/owner/layouts/<%= layout.id %>">View</a>
            <% } %>
          </div>
        </form>
      </div>

      <script>
        const s = document.getElementById('status');

        // Render server error into shared notice (if any)
        const serverError = `<%= (error || '').toString().replace(/`/g, '\\`') %>`;
        if (serverError && serverError.trim().length) {
          s.textContent = serverError;
          s.classList.add('error'); // matches .notice.error in app.css
        }

        // Auto-show notice when it has content
        const mo = new MutationObserver(() => {
          const has = (s.textContent || '').trim().length > 0;
          s.style.display = has ? 'block' : 'none';
        });
        mo.observe(s, { childList: true, subtree: true, characterData: true });

        // initial visibility
        s.style.display = (s.textContent || '').trim().length ? 'block' : 'none';
      </script>

    </div>
  </body>
</html>
